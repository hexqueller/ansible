---
- name: Перенос пакетов на хост
  copy:
    src: "files/{{ item }}"
    dest: "/tmp/{{ item }}"
    mode: '0755'
  loop: "{{ elk_files }}"

- name: Установка rpm's
  yum:
    name: "/tmp/{{ item }}"
    state: present
    disable_gpg_check: yes
  loop: "{{ elk_files }}"

- name: Конфигурация ElasticSearch
  template:
    src: "templates/elasticsearch.yml.j2"
    dest: "/etc/elasticsearch/elasticsearch.yml"

- name: Запуск ElasticSearch
  systemd:
    name: "elasticsearch"
    state: started
    enabled: yes

- name: Сброс пароля Elasticsearch
  command: /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -s -b
  register: raw_elastic_password

- name: Извлечение пароля
  set_fact:
    elastic_password: "{{ raw_elastic_password.stdout }}"

- name: Меняем пароль для учетной записи Kibana
  uri:
    url: "{{ elasticsearch_url }}/_security/user/{{ service_account_name }}/_password"
    method: PUT
    user: "{{ elastic_user }}"
    password: "{{ elastic_password }}"
    validate_certs: no
    body: |
      {
        "password": "{{ kibana_account_password }}"
      }
    body_format: json
    status_code: 200

- name: Создаем учетную запись Viewer
  uri:
    url: "{{ elasticsearch_url }}/_security/user/{{ viewer_account_name }}"
    method: PUT
    user: "{{ elastic_user }}"
    password: "{{ elastic_password }}"
    validate_certs: no
    body: |
      {
        "password": "{{ viewer_account_password }}",
        "roles": ["superuser"],
        "full_name": "Viewer Account",
        "email": "viewer@example.com",
        "metadata": {
          "service": "viewer"
        }
      }
    body_format: json
    status_code: 200

- name: Генерация Service token для Kibana
  shell: "/usr/share/elasticsearch/bin/elasticsearch-service-tokens create elastic/kibana kibana-token"
  register: service_token_output

- name: Извлечение токена
  set_fact:
    service_token: "{{ (service_token_output.stdout | regex_search('SERVICE_TOKEN elastic/kibana/kibana-token = (.+)', '\\1')) | first }}"

- name: Конфигурация Kibana
  template:
    src: "templates/kibana.yml.j2"
    dest: "/etc/kibana/kibana.yml"

- name: Запуск Kibana
  systemd:
    name: "kibana"
    state: started
    enabled: yes
    