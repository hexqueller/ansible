---
- name: Перенос пакетов на хост
  copy:
    src: "files/{{ item }}"
    dest: "/tmp/{{ item }}"
    mode: '0755'
  loop: "{{ elk_files }}"

- name: Установка rpm's
  yum:
    name: "/tmp/{{ item }}"
    state: present
    disable_gpg_check: yes
  loop: "{{ elk_files }}"

- name: Конфигурация ElasticSearch
  template:
    src: "templates/elasticsearch.yml.j2"
    dest: "/etc/elasticsearch/elasticsearch.yml"

- name: Запуск ElasticSearch
  systemd:
    name: "elasticsearch"
    state: started
    enabled: yes

- name: Сброс пароля Elasticsearch
  command: /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -s -b
  register: raw_elastic_password

- name: Извлечение пароля
  set_fact:
    elastic_password: "{{ raw_elastic_password.stdout }}"

- name: Генерация Service token для Kibana
  shell: "/usr/share/elasticsearch/bin/elasticsearch-service-tokens create elastic/kibana token"
  register: service_token_output

- name: Извлечение токена
  set_fact:
    service_token: "{{ service_token_output.stdout | regex_search('SERVICE_TOKEN elastic/kibana/token = (.+)', '\\1') }}"

- name: Конфигурация Kibana
  template:
    src: "templates/kibana.yml.j2"
    dest: "/etc/kibana/kibana.yml"

- name: Запуск Kibana
  systemd:
    name: "kibana"
    state: started
    enabled: yes
    