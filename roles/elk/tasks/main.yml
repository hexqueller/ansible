---
- name: Перенос пакетов на хост
  copy:
    src: "files/{{ item }}"
    dest: "/tmp/{{ item }}"
    mode: '0755'
  loop: "{{ elk_files }}"

- name: Установка rpm's
  yum:
    name: "/tmp/{{ item }}"
    state: present
    disable_gpg_check: yes
  loop: "{{ elk_files }}"

- name: Конфигурация ElasticSearch
  template:
    src: "templates/elasticsearch.yml.j2"
    dest: "/etc/elasticsearch/elasticsearch.yml"

- name: Запуск ElasticSearch
  systemd:
    name: "elasticsearch"
    state: started
    enabled: yes

- name: Генерация Enrollment token для Kibana
  shell: "/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana"
  register: enrollment_token

- name: Конфигурация Kibana
  template:
    src: "templates/kibana.yml.j2"
    dest: "/etc/kibana/kibana.yml"

- name: Запуск Kibana
  systemd:
    name: "kibana"
    state: started
    enabled: yes
    