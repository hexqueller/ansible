---
- name: Перенос пакетов на хост
  copy:
    src: "files/{{ item }}"
    dest: "/tmp/{{ item }}"
    mode: '0755'
  loop: "{{ elk_files }}"

- name: Установка rpm's
  yum:
    name: "/tmp/{{ item }}"
    state: present
    disable_gpg_check: yes
  loop: "{{ elk_files }}"

- name: Конфигурация ElasticSearch
  template:
    src: "templates/elasticsearch.yml.j2"
    dest: "/etc/elasticsearch/elasticsearch.yml"

- name: Запуск ElasticSearch
  systemd:
    name: "elasticsearch"
    state: started
    enabled: yes

- name: Сброс пароля Elasticsearch
  command: /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -s -b
  register: raw_elastic_password

- name: Извлечение пароля
  set_fact:
    elastic_password: "{{ raw_elastic_password.stdout }}"

- name: Сброс пароля Kibana
  command: /usr/share/elasticsearch/bin/elasticsearch-reset-password -u kibana_system -s -b
  register: raw_kibana_password

- name: Извлечение пароля
  set_fact:
    kibana_password: "{{ raw_kibana_password.stdout }}"

- name: Создаем учетную запись Viewer
  uri:
    url: "{{ elasticsearch_url }}/_security/user/{{ viewer_account_name }}"
    method: PUT
    user: "{{ elastic_user }}"
    password: "{{ elastic_password }}"
    validate_certs: no
    body: |
      {
        "password": "{{ viewer_account_password }}",
        "roles": ["superuser"],
        "full_name": "Viewer Account",
        "email": "viewer@example.com",
        "metadata": {
          "service": "viewer"
        }
      }
    body_format: json
    status_code: 200

- name: Конфигурация Kibana
  template:
    src: "templates/kibana.yml.j2"
    dest: "/etc/kibana/kibana.yml"

- name: Конфигурация Logstash
  template:
    src: "templates/logstash/{{ item }}.j2"
    dest: "/etc/logstash/conf.d/{{ item }}"
  loop: "{{ logstash_configs }}"

- name: Запуск сервисов
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop: "{{ elk_services }}"
    